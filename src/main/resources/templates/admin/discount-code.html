<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/admin-layout.html}">
<head>
    <meta charset="UTF-8">
    <title>Quản lý Mã giảm giá</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Custom Styles for Professional Look */
        body {
            background-color: #f4f7f6; /* Light background for context */
        }
        .admin-section-title {
            color: #343a40;
            font-weight: 700;
            padding-bottom: 15px;
            margin-bottom: 25px;
            border-bottom: 3px solid #007bff; /* Accent color border */
        }
        .card {
            border: none;
            border-radius: 0.75rem; /* Smoother corners */
            transition: all 0.3s ease;
        }
        .form-group label {
            font-size: 0.85rem;
            color: #495057;
            font-weight: 500; /* Làm nhãn trông nhẹ nhàng hơn */
        }

        /* --- Custom Button Styles (Enhanced for Maximum Visibility) --- */

        /* Primary Button (Tìm kiếm) */
        .btn-primary-custom {
            background-color: #007bff; /* Standard Blue */
            border-color: #007bff;
            font-weight: 700; /* Bolder text */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* More responsive transition */
            border-radius: 0.5rem;
            box-shadow: 0 3px 6px rgba(0, 123, 255, 0.3);
        }
        .btn-primary-custom:hover {
            background-color: #0069d9;
            border-color: #0062cc;
            transform: translateY(-4px); /* Tăng độ nâng lên */
            box-shadow: 0 14px 30px rgba(0, 123, 255, 0.6); /* Bóng đổ sâu hơn và nổi bật hơn */
        }

        /* Secondary Button (Đặt lại) */
        .btn-outline-secondary-custom {
            color: #6c757d;
            border: 2px solid #ced4da; /* Lighter border */
            background-color: #fff;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(108, 117, 125, 0.1);
        }
        .btn-outline-secondary-custom:hover {
            color: #495057;
            background-color: #f8f9fa;
            border-color: #495057; /* Tăng độ đậm của viền khi hover */
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25); /* Bóng đổ rõ ràng hơn */
        }

        /* Success Button (Thêm mã giảm giá) - THE MAIN CALL TO ACTION */
        .btn-success-lg-custom {
            /* Strong Green Gradient - Green to Cyan/Teal for uniqueness */
            background-image: linear-gradient(135deg, #28a745 0%, #17a2b8 100%);
            border: none;
            font-weight: 800; /* Extra bold */
            color: #ffffff;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 1rem 2rem;
            font-size: 1.25rem;
            border-radius: 0.75rem;
            /* Initial shadow for presence */
            box-shadow: 0 6px 12px rgba(40, 167, 69, 0.4);
            cursor: pointer;
        }
        .btn-success-lg-custom:hover {
            /* Reverse gradient direction and rotate slightly for dynamic effect */
            background-image: linear-gradient(135deg, #17a2b8 0%, #28a745 100%);
            transform: scale(1.06) translateY(-6px) rotateZ(0.5deg); /* Nâng lên mạnh, phóng to và xoay nhẹ */
            /* Stronger, glowing shadow */
            box-shadow: 0 20px 40px rgba(23, 162, 184, 0.9); /* Bóng đổ cực kỳ sâu và tỏa sáng */
        }
        /* --- End Custom Button Styles --- */

        /* Table Styling */
        .table-custom thead th {
            font-weight: 600;
            background-color: #343a40;
            color: #ffffff;
            vertical-align: middle;
            text-align: center;
        }
        .table-custom tbody td, .table-custom tbody th {
            vertical-align: middle;
            text-align: center;
        }
        .table-custom tbody td:nth-child(2) { /* Mã giảm giá - Căn trái */
            text-align: left;
            font-weight: 500;
        }
        .action-icon-group svg {
            transition: transform 0.2s;
            cursor: pointer;
        }
        .action-icon-group svg:hover {
            transform: scale(1.15);
        }
        .badge-pill {
            min-width: 80px;
            font-size: 0.8rem;
            padding: 0.4em 0.8em;
        }
    </style>
</head>
<body>
<div id="app" layout:fragment="content">
    <h4 class="admin-section-title">Quản lý Mã giảm giá</h4>

    <!-- Search / Filter Section -->
    <div class="card p-4 shadow-lg mb-4">
        <h6 class="card-title text-primary font-weight-bold mb-3"><i class="fas fa-filter mr-2"></i>Bộ lọc & Tìm kiếm</h6>
        <form id="search-form">
            <div class="form-row align-items-end">
                <!-- Mã giảm giá -->
                <div class="form-group col-md-2">
                    <label for="code"><i class="fas fa-tag mr-1 text-muted"></i> Mã giảm giá</label>
                    <input type="text" class="form-control" id="code" name="code" placeholder="VD: OAS123"
                           th:value="${dataSearch.code}">
                </div>
                <!-- Ngày áp dụng -->
                <div class="form-group col-md-2">
                    <label for="startDate"><i class="fas fa-calendar-alt mr-1 text-muted"></i> Ngày áp dụng</label>
                    <input type="date" class="form-control" id="startDate" name="startDate"
                           th:value="${#dates.format(dataSearch.startDate, 'yyyy-MM-dd')}">
                </div>
                <!-- Ngày kết thúc -->
                <div class="form-group col-md-2">
                    <label for="endDate"><i class="fas fa-calendar-times mr-1 text-muted"></i> Ngày kết thúc</label>
                    <input type="date" class="form-control" id="endDate" name="endDate"
                           th:value="${#dates.format(dataSearch.endDate, 'yyyy-MM-dd')}">
                </div>
<!--                 Trạng thái -->
<!--                                <div class="form-group col-md-2">-->
<!--                                    <label for="status"><i class="fas fa-check-circle mr-1 text-muted"></i> Trạng thái</label>-->
<!--                                    <select class="form-control" id="status" th:value="${dataSearch.status}">-->
<!--                                        <option value="">&#45;&#45; Tất cả &#45;&#45;</option>-->
<!--                                        <option value="1" th:selected="${dataSearch.status == 1}">Đang hoạt động</option>-->
<!--                                        <option value="0" th:selected="${dataSearch.status == 0}">Đã đóng</option>-->
<!--                                    </select>-->
<!--                                </div>-->
<!--                 Số lượng còn -->
                <div class="form-group col-md-2">
                    <label for="maximumUsage"><i class="fas fa-sort-numeric-up-alt mr-1 text-muted"></i> Số lượng còn</label>
                    <input type="text" class="form-control" id="maximumUsage" name="maximumUsage" placeholder="VD: 1234"
                           th:value="${dataSearch.maximumUsage}">
                </div>

                <!-- Action Buttons -->
                <div class="form-group col-md-2 mb-0 d-flex justify-content-end">
                    <button type="button" id="search-btn" class="btn btn-primary-custom mr-2 flex-grow-1 shadow-sm">
                        <i class="fas fa-search mr-1"></i> Tìm kiếm
                    </button>
                    <!-- Đã đổi icon từ fa-times sang fa-redo-alt cho trực quan hơn -->
                    <a th:href="@{/admin-only/discount-code}" class="btn btn-outline-secondary-custom shadow-sm" title="Đặt lại bộ lọc">
                        <i class="fas fa-redo-alt"></i>
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- Action Bar & Alert -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <!-- Áp dụng style chuyên nghiệp cho nút Thêm mới -->
        <a th:href="@{/admin-only/discount-code-create}" class="btn btn-success-lg-custom shadow-sm">
            <i class="fas fa-plus mr-2"></i> Thêm mã giảm giá
        </a>
        <div class="alert alert-success py-2 px-3 m-0 shadow-sm" th:if="${message != null}" th:text="${message}"></div>
    </div>

    <!-- Data Table -->
    <div class="card shadow-lg p-3">
        <div class="table-responsive">
            <table class="table table-custom table-bordered table-hover table-striped my-3">
                <thead class="thead-dark">
                <tr>
                    <th scope="col" style="width: 5%">#</th>
                    <th scope="col" style="width: 15%; text-align: left;">Mã giảm giá</th>
                    <th scope="col" style="width: 15%">Ngày áp dụng</th>
                    <th scope="col" style="width: 15%">Ngày hết hạn</th>
                    <th scope="col" style="width: 10%">Kiểu</th>
                    <th scope="col" style="width: 15%">Giá trị giảm</th>
                    <th scope="col" style="width: 10%">Còn</th>
<!--                    <th scope="col" style="width: 10%">Trạng thái</th>-->
                    <th style="width: 10%">Công cụ</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="discountCode, iStat : ${discountCodes}">
                    <th scope="row" th:text="${iStat.count}"></th>
                    <td th:text="${discountCode.code}" style="text-align: left;"></td>
                    <td th:text="${#dates.format(discountCode.startDate, 'dd/MM/yyyy')}"></td>
                    <td th:text="${#dates.format(discountCode.endDate, 'dd/MM/yyyy')}"></td>

                    <!-- Kiểu giảm giá -->
                    <td th:text="${discountCode.getType() == 1 ? 'Phần trăm' : 'Số tiền'}"></td>

                    <!-- Giá trị giảm -->
                    <td>
                        <span th:if="${discountCode.getType() == 1}" th:text="${discountCode.getPercentage() + '%'}"></span>
                        <span th:if="${discountCode.getType() == 2}"
                              th:text="${#numbers.formatDecimal(discountCode.getDiscountAmount(), 0, 'POINT', 0, 'COMMA')}"></span>
                    </td>

                    <td th:text="${discountCode.maximumUsage}"></td>

                    <!-- Trạng thái -->
<!--                    <td>-->
<!--                        <span th:if="${discountCode.status == 0}" class="badge badge-pill badge-danger">Đã đóng</span>-->
<!--                        <span th:if="${discountCode.status == 1}" class="badge badge-pill badge-success">Hoạt động</span>-->
<!--                    </td>-->

                    <!-- Công cụ -->
                    <td class="action-icon-group">
                        <!-- Nút Đóng -->
                        <form th:if="${discountCode.status == 1}" th:action="@{/admin/update-discount-status/0}" method="post"
                              class="form-close-discount d-inline mx-1">
                            <input type="hidden" name="id" th:value="${discountCode.id}">
                            <button type="submit" class="border-0 bg-transparent cursor-pointer p-0" title="Đóng mã giảm giá">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                                    <path fill="#dc3545" d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10s10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17L12 13.41L8.41 17L7 15.59L10.59 12L7 8.41L8.41 7L12 10.59L15.59 7L17 8.41L13.41 12L17 15.59z"/>
                                </svg>
                            </button>
                        </form>

                        <!-- Nút Mở -->
                        <form th:if="${discountCode.status == 0}" th:action="@{/admin/update-discount-status/1}" method="post"
                              class="form-open-discount d-inline mx-1">
                            <input type="hidden" name="id" th:value="${discountCode.id}">
                            <button type="submit" class="border-0 bg-transparent cursor-pointer p-0" title="Mở mã giảm giá">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                                    <path fill="#28a745" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5l1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                </svg>
                            </button>
                        </form>

                        <!-- Nút Sửa -->
                        <a th:href="@{'/admin-only/discount-code/edit/' + ${discountCode.id}}" class="cursor-pointer mx-1" title="Chỉnh sửa">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                                <path fill="#007bff" d="m7 17.013l4.413-.015l9.632-9.54c.378-.378.586-.88.586-1.414s-.208-1.036-.586-1.414l-1.586-1.586c-.756-.756-2.075-.752-2.825-.003L7 12.583v4.43zM18.045 4.458l1.589 1.583l-1.597 1.582l-1.586-1.585l1.594-1.58zM9 13.417l6.03-5.973l1.586 1.586l-6.029 5.971L9 15.006v-1.589z"/>
                                <path fill="#007bff" d="M5 21h14c1.103 0 2-.897 2-2v-8.668l-2 2V19H8.158c-.026 0-.053.01-.079.01c-.033 0-.066-.009-.1-.01H5V5h6.847l2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2z"/>
                            </svg>
                        </a>
                    </td>
                </tr>

                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <div class="d-flex justify-content-end mt-4 mb-4">
        <ul id="pagination" class=""></ul>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" th:inline="javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twbs-pagination/1.4.2/jquery.twbsPagination.min.js"></script>

    <!-- Custom Script -->
    <script th:inline="javascript">
        // --- Global Variables ---
        var totalPage = /*[[${totalPage}]]*/ 1;
        var currentPage = /*[[${currentPage}]]*/ 0;
        var baseUrl = '/admin-only/discount-code';

        // --- Event Listeners ---

        // 1. Confirmation for Closing Discount Code
        $(".form-close-discount").on('submit', function (e) {
            e.preventDefault();
            var form = this;

            Swal.fire({
                title: 'Đóng mã giảm giá',
                text: 'Bạn chắc chắc muốn đóng mã giảm giá này?',
                icon: 'warning',
                showCancelButton: true,
                cancelButtonText: 'Hủy',
                confirmButtonText: 'Xác nhận',
                reverseButtons: true
            }).then(async (result) => {
                if (result.isConfirmed) {
                    form.submit();
                }
            });
        });

        // 2. Search Button Logic
        $('#search-btn').on('click', function () {
            var code = $('#code').val().trim();
            var startDate = $("#startDate").val();
            var endDate = $("#endDate").val();
            var status = $("#status").val();
            var maximumUsage = $("#maximumUsage").val();

            if (startDate && endDate) {
                if (startDate >= endDate) {
                    Swal.fire({
                        text: 'Ngày bắt đầu phải nhỏ hơn ngày kết thúc',
                        icon: 'error'
                    });
                    return;
                }
            }

            var params = [];
            if (code) {
                params.push('code=' + code);
            }
            if (startDate) {
                params.push('startDate=' + startDate);
            }
            if (endDate) {
                params.push('endDate=' + endDate);
            }
            if (status !== '') { // Use strict comparison for status
                params.push('status=' + status);
            }
            if (maximumUsage) {
                params.push('maximumUsage=' + maximumUsage);
            }

            // Start with page 0 when searching
            var url = baseUrl + '?page=0';

            if (params.length > 0) {
                url += '&' + params.join('&');
            }

            window.location.href = url;
        });

        // 3. Pagination Setup
        $('#pagination').twbsPagination({
            startPage: parseInt(currentPage) + 1,
            totalPages: parseInt(totalPage),
            visiblePages: 5,
            // Use custom icons for better UX (requires font awesome library)
            first: '<i class="fas fa-angle-double-left"></i>',
            prev: '<i class="fas fa-angle-left"></i>',
            next: '<i class="fas fa-angle-right"></i>',
            last: '<i class="fas fa-angle-double-right"></i>',
            initiateStartPageClick: false,

            onPageClick: function (event, page) {
                // Get the current URL parameters excluding 'page'
                var currentUrl = window.location.href;
                var urlObj = new URL(currentUrl);
                var searchParams = urlObj.searchParams;

                // Update the page parameter
                searchParams.set('page', (page - 1));

                // Reconstruct the URL
                var newUrl = urlObj.origin + urlObj.pathname + '?' + searchParams.toString();

                window.location.href = newUrl;
            }
        });
    </script>
</div>
</body>
</html>
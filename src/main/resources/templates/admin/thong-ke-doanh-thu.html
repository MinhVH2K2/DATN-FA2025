<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/admin-layout.html}">
<head>
    <meta charset="UTF-8">
    <title>Th·ªëng k√™ doanh thu</title>
</head>
<body>
<div class="main-wrapper" layout:fragment="content">
    <h2 class="mb-4 text-primary">üìä Th·ªëng k√™ Doanh thu</h2>

    <div class="row g-4 mb-5">
        <div class="col-xl-3 col-md-6 col-sm-12">
            <div class="card shadow-sm border-left-primary h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                T·ªïng doanh thu
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${#numbers.formatDecimal(revenueAll, 0, 'POINT', 0, 'COMMA')}"></div>
                        </div>
                        <div class="col-auto">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#007bff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-dollar-sign">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 col-sm-12">
            <div class="card shadow-sm border-left-success h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Doanh thu h√¥m nay
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${#numbers.formatDecimal(revenueToday, 0, 'POINT', 0, 'COMMA')}"></div>
                            <div class="mt-1">
                                <span th:classappend="${percentageYesterday >= 0 ? 'text-success' : 'text-danger'}" class="mr-2">
                                    <svg th:if="${percentageYesterday >= 0}" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 20 20"><path fill="green" d="M14 2.75a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 .75.75v2.5a.75.75 0 0 1-1.5 0v-.69l-4.47 4.47a.75.75 0 0 1-1.06 0L8.5 6.56l-4.22 4.22a.75.75 0 1 1-1.06-1.06l4.75-4.75a.75.75 0 0 1 1.06 0l2.47 2.47l3.94-3.94h-.69a.75.75 0 0 1-.75-.75ZM3.75 14a.75.75 0 0 1 .75.75v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 .75-.75Zm4.75-2.25a.75.75 0 0 0-1.5 0v5.5a.75.75 0 0 0 1.5 0v-5.5ZM11.75 13a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5a.75.75 0 0 1 .75-.75Zm4.75-3.25a.75.75 0 0 0-1.5 0v7.5a.75.75 0 0 0 1.5 0v-7.5Z"/></svg>
                                    <svg th:if="${percentageYesterday < 0}" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 14 14"><path fill="none" stroke="red" stroke-linecap="round" stroke-linejoin="round" d="m1.24.5l11.5 5.23m-2.15.81l2.15-.81l-.8-2.16M1.25 6h1.5a.5.5 0 0 1 .5.5v7H.75v-7a.5.5 0 0 1 .5-.5v0Zm5 1.5h1.5a.5.5 0 0 1 .5.5v5.5h-2.5V8a.5.5 0 0 1 .5-.5v0Zm5 1.5h1.5a.5.5 0 0 1 .5.5v4h-2.5v-4a.5.5 0 0 1 .5-.5Z"/></svg>
                                    <span th:if="${percentageYesterday != 99}" th:text="${#numbers.formatDecimal(percentageYesterday, 0, 2)} + '%'"></span>
                                    <span th:if="${percentageYesterday == 99}">99+%</span>
                                </span>
                                <span class="text-muted small"> so v·ªõi h√¥m qua</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 col-sm-12">
            <div class="card shadow-sm border-left-info h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Doanh thu tu·∫ßn n√†y
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${#numbers.formatDecimal(revenueWeek, 0, 'POINT', 0, 'COMMA')}"></div>
                            <div class="mt-1">
                                <span th:classappend="${percentageLastWeek >= 0 ? 'text-success' : 'text-danger'}" class="mr-2">
                                    <svg th:if="${percentageLastWeek >= 0}" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 20 20"><path fill="green" d="M14 2.75a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 .75.75v2.5a.75.75 0 0 1-1.5 0v-.69l-4.47 4.47a.75.75 0 0 1-1.06 0L8.5 6.56l-4.22 4.22a.75.75 0 1 1-1.06-1.06l4.75-4.75a.75.75 0 0 1 1.06 0l2.47 2.47l3.94-3.94h-.69a.75.75 0 0 1-.75-.75ZM3.75 14a.75.75 0 0 1 .75.75v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 .75-.75Zm4.75-2.25a.75.75 0 0 0-1.5 0v5.5a.75.75 0 0 0 1.5 0v-5.5ZM11.75 13a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5a.75.75 0 0 1 .75-.75Zm4.75-3.25a.75.75 0 0 0-1.5 0v7.5a.75.75 0 0 0 1.5 0v-7.5Z"/></svg>
                                    <svg th:if="${percentageLastWeek < 0}" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 14 14"><path fill="none" stroke="red" stroke-linecap="round" stroke-linejoin="round" d="m1.24.5l11.5 5.23m-2.15.81l2.15-.81l-.8-2.16M1.25 6h1.5a.5.5 0 0 1 .5.5v7H.75v-7a.5.5 0 0 1 .5-.5v0Zm5 1.5h1.5a.5.5 0 0 1 .5.5v5.5h-2.5V8a.5.5 0 0 1 .5-.5v0Zm5 1.5h1.5a.5.5 0 0 1 .5.5v4h-2.5v-4a.5.5 0 0 1 .5-.5Z"/></svg>
                                    <span th:if="${percentageLastWeek != 99}" th:text="${#numbers.formatDecimal(percentageLastWeek, 0, 2)} + '%'"></span>
                                    <span th:if="${percentageLastWeek == 99}">99+%</span>
                                </span>
                                <span class="text-muted small"> so v·ªõi tu·∫ßn tr∆∞·ªõc</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 col-sm-12">
            <div class="card shadow-sm border-left-warning h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Doanh thu th√°ng n√†y
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${#numbers.formatDecimal(revenueMonth, 0, 'POINT', 0, 'COMMA')}"></div>
                            <div class="mt-1">
                                <span th:classappend="${percentageLastMonth >= 0 ? 'text-success' : 'text-danger'}" class="mr-2">
                                    <svg th:if="${percentageLastMonth >= 0}" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 20 20"><path fill="green" d="M14 2.75a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 .75.75v2.5a.75.75 0 0 1-1.5 0v-.69l-4.47 4.47a.75.75 0 0 1-1.06 0L8.5 6.56l-4.22 4.22a.75.75 0 1 1-1.06-1.06l4.75-4.75a.75.75 0 0 1 1.06 0l2.47 2.47l3.94-3.94h-.69a.75.75 0 0 1-.75-.75ZM3.75 14a.75.75 0 0 1 .75.75v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 .75-.75Zm4.75-2.25a.75.75 0 0 0-1.5 0v5.5a.75.75 0 0 0 1.5 0v-5.5ZM11.75 13a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5a.75.75 0 0 1 .75-.75Zm4.75-3.25a.75.75 0 0 0-1.5 0v7.5a.75.75 0 0 0 1.5 0v-7.5Z"/></svg>
                                    <svg th:if="${percentageLastMonth < 0}" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 14 14"><path fill="none" stroke="red" stroke-linecap="round" stroke-linejoin="round" d="m1.24.5l11.5 5.23m-2.15.81l2.15-.81l-.8-2.16M1.25 6h1.5a.5.5 0 0 1 .5.5v7H.75v-7a.5.5 0 0 1 .5-.5v0Zm5 1.5h1.5a.5.5 0 0 1 .5.5v5.5h-2.5V8a.5.5 0 0 1 .5-.5v0Zm5 1.5h1.5a.5.5 0 0 1 .5.5v4h-2.5v-4a.5.5 0 0 1 .5-.5Z"/></svg>
                                    <span th:if="${percentageLastMonth != 99}" th:text="${#numbers.formatDecimal(percentageLastMonth, 0, 2)} + '%'"></span>
                                    <span th:if="${percentageLastMonth == 99}">99+%</span>
                                </span>
                                <span class="text-muted small"> so v·ªõi th√°ng tr∆∞·ªõc</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-lg-6 revenue-month">
            <div class="card shadow-sm">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Doanh thu theo t·ª´ng th√°ng</h6>
                    <div class="d-flex align-items-center">
                        <label class="mr-2 mb-0">Th√°ng</label>
                        <select class="form-select form-control-sm mr-2" id="month" style="width: 100px;">
                            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                            <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
                            <option value="9">9</option><option value="10">10</option><option value="11" selected>11</option><option value="12">12</option>
                        </select>
                        <select class="form-select form-control-sm" id="year" style="width: 100px;">
                            <option value="2025">2025</option><option value="2024">2024</option><option value="2023">2023</option>
                            <option value="2022">2022</option><option value="2021">2021</option><option value="2020">2020</option>
                            <option value="2019">2019</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="revenueDayInMonth"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-6 revenue-year">
            <div class="card shadow-sm">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Doanh thu theo t·ª´ng nƒÉm</h6>
                    <select class="form-select form-control-sm" id="monthYear" style="width: 100px;">
                        <option value="2025">2025</option><option value="2024">2024</option><option value="2023">2023</option>
                        <option value="2022">2022</option><option value="2021">2021</option><option value="2020">2020</option>
                        <option value="2019">2019</option>
                    </select>
                </div>
                <div class="card-body">
                    <canvas id="revenueMonthInYear"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-5">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Theo kho·∫£ng th·ªùi gian</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap align-items-end mb-4">
                        <div class="form-group mr-3">
                            <label class="form-label">Lo·∫°i th·ªùi gian</label>
                            <select class="form-select form-control" id="time-category">
                                <option value="1">Theo kho·∫£ng ng√†y</option>
                                <option value="2">Theo th√°ng</option>
                            </select>
                        </div>

                        <div class="form-group mr-3 by-date">
                            <label class="form-label">Ng√†y b·∫Øt ƒë·∫ßu</label>
                            <input type="date" id="dateStart" class="form-control" >
                        </div>
                        <div class="form-group mr-3 by-date">
                            <label class="form-label">Ng√†y k·∫øt th√∫c</label>
                            <input type="date" id="dateEnd" class="form-control">
                        </div>

                        <div class="form-group mr-3 by-month" style="display:none;">
                            <label class="form-label">Th√°ng b·∫Øt ƒë·∫ßu</label>
                            <input type="month" id="monthStart" class="form-control" >
                        </div>
                        <div class="form-group mr-3 by-month" style="display:none;">
                            <label class="form-label">Th√°ng k·∫øt th√∫c</label>
                            <input type="month" id="monthEnd" class="form-control">
                        </div>

                        <div class="form-group mr-3">
                            <button id="apply-statistic" class="btn btn-primary">√Åp d·ª•ng</button>
                        </div>

                        <div class="form-group">
                            <button type="button" id="export" class="btn btn-outline-success">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 48 48"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="4"><path stroke-linejoin="round" d="M8 15V6a2 2 0 0 1 2-2h28a2 2 0 0 1 2 2v36a2 2 0 0 1-2 2H10a2 2 0 0 1-2-2v-9"/><path d="M31 15h3m-6 8h6m-6 8h6"/><path stroke-linejoin="round" d="M4 15h18v18H4zm6 6l6 6m0-6l-6 6"/></g></svg>
                                Export Excel
                            </button>
                        </div>
                    </div>

                    <div class="chart-area" style="width: 100%; height: 400px">
                        <canvas id="revenueInTime"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script>
        // Get today's date
        var currentDate = new Date();

        // Set the "dateEnd" input value to today's date
        var dateEndInput = document.getElementById("dateEnd");
        dateEndInput.value = formatDate(currentDate);

        // Calculate the date 30 days ago
        var dateStart = new Date(currentDate);
        dateStart.setDate(currentDate.getDate() - 30);

        // Set the "dateStart" input value to 30 days ago
        var dateStartInput = document.getElementById("dateStart");
        dateStartInput.value = formatDate(dateStart);

        // Set the "monthStart" input value to the current month
        var monthStartInput = document.getElementById("monthStart");
        monthStartInput.value = formatMonth(currentDate, 'month');

        // Calculate the date with the current month plus 12
        var monthEnd = new Date(currentDate.getFullYear() + 1, currentDate.getMonth()); // T√≠nh th√°ng k·∫øt th√∫c l√† 1 nƒÉm sau

        // Set the "monthEnd" input value to the date with the current month plus 12
        var monthEndInput = document.getElementById("monthEnd");
        monthEndInput.value = formatMonth(monthEnd, 'month');

        // Function to format the date as "YYYY-MM"
        function formatMonth(date, format) {
            var year = date.getFullYear();
            var month = String(date.getMonth() + 1).padStart(2, '0');
            if (format === 'month') {
                return year + '-' + month;
            } else {
                var day = String(date.getDate()).padStart(2, '0');
                return year + '-' + month + '-' + day;
            }
        }

        // Function to format the date as "YYYY-MM-DD"
        function formatDate(date) {
            var year = date.getFullYear();
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var day = String(date.getDate()).padStart(2, '0');
            return year + '-' + month + '-' + day;
        }

        $('#time-category').on('change', function () {
            var value = $(this).val()

            if(value == 1) {
                $('.by-date').show()
                $('.by-month').hide()
            }

            if(value == 2) {
                $('.by-date').hide()
                $('.by-month').show()
            }
        })

    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var $revenueDayInMonth = $('#revenueDayInMonth');
            var $revenueMonthInYear = $('#revenueMonthInYear')
            var $revenueInTime = $('#revenueInTime')
            $('#month').on('change', function () {
                callApiGetInMonth($(this).val(), $('#year').val())
            })

            $('#year').on('change', function () {
                callApiGetInMonth($("#month").val(), $(this).val())
            })

            $('#monthYear').on('change', function () {
                callApiGetInYear($(this).val())
            })

            $('.by-date').show()
            $('.by-month').hide()

            const plugin = {
                id: 'customCanvasBackgroundColor',
                beforeDraw: (chart, args, options) => {
                    const {ctx} = chart;
                    ctx.save();
                    ctx.globalCompositeOperation = 'destination-over';
                    ctx.fillStyle = options.color || '#99ffff';
                    ctx.fillRect(0, 0, chart.width, chart.height);
                    ctx.restore();
                }
            };


            callApiGetInMonth(11, 2023)
            callApiGetInYear(2023)

            function callApiGetInMonth(month, year) {
                $.ajax({
                    type: 'GET',
                    dataType: 'json',
                    url: `/api/get-statistic-revenue-day-in-month?month=${month}&year=${year}`,
                    success: function (data) {
                        var lableList = []
                        var dataList = []
                        data.forEach(item => {
                            lableList.push(item.date)
                            dataList.push(item.revenue)
                        })

                        loadChart(lableList, dataList)
                    }
                })
            }

            function callApiGetInYear(year) {
                $.ajax({
                    type: 'GET',
                    dataType: 'json',
                    url: `/api/get-statistic-revenue-month-in-year?year=${year}`,
                    success: function (data) {
                        var lableList = []
                        var dataList = []
                        data.forEach(item => {
                            lableList.push(item.month)
                            dataList.push(item.revenue)
                        })

                        loadChartYear(lableList, dataList)
                    }
                })
            }

            function loadChart(labelList, dataList) {
                const label = `Doanh thu`
                let chartStatus = Chart.getChart("revenueDayInMonth"); // <canvas> id
                if (chartStatus != undefined) {
                    chartStatus.destroy();
                }
                var chart = new Chart($revenueDayInMonth, {
                    type: 'line',
                    data: {
                        labels: labelList,  // C√°c th√°ng c·ªßa nƒÉm
                        datasets: [
                            {
                                label: label,
                                data: dataList,

                                borderColor: 'rgb(0,143,255)',
                                tension: 0.1
                            },
                        ]
                    },

                    options: {

                        plugins: {
                            title: {
                                display: true,
                                text: `Doanh thu th√°ng ${$('#month').val()}-${$('#year').val()}`
                            },
                            customCanvasBackgroundColor: {
                                color: '#fff',
                            }
                        }
                    },

                    plugins: [plugin],
                });
            }
            function loadChartYear(labelList, dataList) {
                let chartStatus = Chart.getChart("revenueMonthInYear"); // <canvas> id
                if (chartStatus != undefined) {
                    chartStatus.destroy();
                }
                var chart = new Chart($revenueMonthInYear, {
                    type: 'line',
                    data: {
                        labels: labelList,  // C√°c th√°ng c·ªßa nƒÉm
                        datasets: [
                            {
                                label: 'Doanh thu',
                                data: dataList,

                                borderColor: 'rgb(0,143,255)',
                                tension: 0.1
                            },
                        ]
                    },

                    options: {

                        plugins: {
                            title: {
                                display: true,
                                text: `Doanh thu nƒÉm ${$('#monthYear').val()}`
                            },
                            customCanvasBackgroundColor: {
                                color: '#fff',
                            }
                        }
                    },

                    plugins: [plugin],
                });
            }
        });

        callApiStatisInTime($('#dateStart').val(), $('#dateEnd').val())


        $('#apply-statistic').on('click', function () {
            var selectValue = $('#time-category').val()
            if(selectValue == 1) {
                handleStatisTicFromDate()
            }else  {
                handlehandleStatisTicFromMonth()
            }
        })

        function handleStatisTicFromDate() {
            const startDate = $('#dateStart').val()
            const toDate = $('#dateEnd').val()
            if(!startDate) {
                Toastify({
                    text: "Vui l√≤ng nh√¢p ng√†y b·∫Øt ƒë·∫ßu",
                    className: "error",
                    style: {
                        background: "red",
                        color: "white"
                    }
                }).showToast();
                return
            }

            if(toDate == "") {
                Toastify({
                    text: "Vui l√≤ng nh√¢p ng√†y k·∫øt th√∫c",
                    className: "error",
                    style: {
                        background: "red",
                        color: "white"
                    }
                }).showToast();
                return;
            }

            if(startDate >= toDate) {
                Toastify({
                    text: "Ng√†y k·∫øt th√∫c ph·∫£i l·ªõn h∆°n ng√†y b·∫Øt ƒë·∫ßu",
                    className: "error",
                    style: {
                        background: "red",
                        color: "white"
                    }
                }).showToast();
                return;
            }

            const timeDifference = new Date(toDate).getTime() - new Date(startDate).getTime();

            // Calculate the difference in days
            const dayDifference = timeDifference / (1000 * 60 * 60 * 24);

            // Check if the difference is within the allowed range (60 days)
            if (dayDifference > 60) {
                Toastify({
                    text: "Kho·∫£ng c√°ch gi·ªØa ng√†y b·∫Øt ƒë·∫ßu v√† ng√†y k·∫øt th√∫c kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 60 ng√†y",
                    className: "error",
                    style: {
                        background: "red",
                        color: "white"
                    }
                }).showToast();
                return;
            }

            callApiStatisInTime(startDate, toDate)
        }
        function handlehandleStatisTicFromMonth() {
            const startMonth = $('#monthStart').val();
            const toMonth = $('#monthEnd').val();
            if(!startMonth) {
                Toastify({
                    text: "Vui l√≤ng nh√¢p th√°ng b·∫Øt ƒë·∫ßu",
                    className: "error",
                    style: {
                        background: "red",
                        color: "white"
                    }
                }).showToast();
                return
            }

            if(!toMonth) {
                Toastify({
                    text: "Vui l√≤ng nh√¢p th√°ng k·∫øt th√∫c",
                    className: "error",
                    style: {
                        background: "red",
                        color: "white"
                    }
                }).showToast();
                return
            }

            const startDate = new Date(startMonth + '-01');
            const toDate = new Date(toMonth + '-01');

            const monthDifference = (toDate.getFullYear() - startDate.getFullYear()) * 12 + (toDate.getMonth() - startDate.getMonth());

            if (toDate <= startDate) {
                // Valid
                Toastify({
                    text: "Th√°ng k·∫øt th√∫c ph·∫£i l·ªõn h∆°n th√°ng b·∫Øt ƒë·∫ßu",
                    className: "error",
                    style: {
                        background: "red",
                        color: "white"
                    }
                }).showToast();
            } else if(monthDifference > 60) {
                Toastify({
                    text: "Kho·∫£ng c√°ch gi·ªØa c√°c th√°ng kh√¥ng l·ªõn h∆°n 5 nƒÉm (60 th√°ng)",
                    className: "error",
                    style: {
                        background: "red",
                        color: "white"
                    }
                }).showToast();
            } else {
                callApiStatisticInMonth(startMonth, toMonth)
            }

        }

        function callApiStatisInTime(startDate, toDate) {
            $.ajax({
                type: 'GET',
                dataType: 'json',
                url: `/api/get-statistic-revenue-day-from-time?fromDate=${startDate}&toDate=${toDate}`,
                success: function (data) {
                    var lableList = []
                    var dataList = []
                    data.forEach(item => {
                        lableList.push(item.date)
                        dataList.push(item.revenue)
                    })
                    loadChartInTime(lableList, dataList)
                }
            })
        }

        function callApiStatisticInMonth(startMonth, toMonth) {
            $.ajax({
                type: 'GET',
                dataType: 'json',
                url: `/api/get-statistic-revenue-month-from-time?fromMonth=${startMonth}&toMonth=${toMonth}`,
                success: function (data) {
                    var lableList = []
                    var dataList = []
                    data.forEach(item => {
                        lableList.push(item.month)
                        dataList.push(item.revenue)
                    })
                    loadChartInTime(lableList, dataList)
                }
            })

        }

        function loadChartInTime(labelList, dataList) {
            let chartStatus = Chart.getChart("revenueInTime"); // <canvas> id
            if (chartStatus != undefined) {
                chartStatus.destroy();
            }
            var chart = new Chart($('#revenueInTime'), {
                type: 'scatter',
                data: {
                    labels: labelList,  // C√°c th√°ng c·ªßa nƒÉm
                    datasets: [
                        {
                            type: 'bar',
                            label: 'Doanh thu',
                            data: dataList,

                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: '#ff6384',
                        },
                    ]
                },

                options: {

                    plugins: {
                        title: {
                            display: true,
                            text: `Bi·ªÉu ƒë·ªì doanh thu`
                        },
                        customCanvasBackgroundColor: {
                            color: '#fff',
                        }
                    }
                },
                plugins: [plugin],
            });
        }

        $('#export').on('click', exportToExcel)

        async function exportToExcel() {
            if($('#time-category').val() == 1) {
                /* fetch JSON data and parse */
                const url = `/api/get-statistic-revenue-day-from-time?fromDate=${$('#dateStart').val()}&toDate=${$('#dateEnd').val()}`;
                const raw_data = await (await fetch(url)).json();
                /* generate worksheet and workbook */
                const worksheet = XLSX.utils.json_to_sheet(raw_data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "SanPham");
                const heading =[
                    ["Ng√†y", "Doanh thu"]
                ]
                /* fix headers */
                XLSX.utils.sheet_add_aoa(worksheet,heading , {origin: "A1"});
                /* create an XLSX file and try to save to Presidents.xlsx */
                XLSX.writeFile(workbook, `thong-ke-doanh-thu_${$('#dateStart').val()}-${$('#dateEnd').val()}.xlsx`, {compression: true});
            }
            else {
                // TODO: X·ª≠ l√Ω logic export theo th√°ng (if required)
            }
        }


        function formatToYYYYMMDD(date) {
            var yyyy = date.getFullYear().toString();
            var mm = (date.getMonth() + 1).toString().padStart(2, '0');
            var dd = date.getDate().toString().padStart(2, '0');
            return yyyy + '-' + mm + '-' + dd;
        }
        function formatNumber(number) {
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function removeAnyNonDigit(value) {
            return value.replace(/\D/g, '');
        }

        const plugin = {
            id: 'customCanvasBackgroundColor',
            beforeDraw: (chart, args, options) => {
                const {ctx} = chart;
                ctx.save();
                ctx.globalCompositeOperation = 'destination-over';
                ctx.fillStyle = options.color || '#fff'; // ƒê√£ ƒë·ªïi m√†u n·ªÅn v·ªÅ tr·∫Øng
                ctx.fillRect(0, 0, chart.width, chart.height);
                ctx.restore();
            }
        };
    </script>
</div>
</body>
</html>
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/admin-layout.html}">

<head>
    <meta charset="UTF-8" />
    <title>Chi tiết hóa đơn</title>
    <style>
        /* CSS để làm nổi bật tổng tiền */
        .total-summary {
            background-color: #f8f8f8; /* Nền xám nhẹ */
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .total-summary .final-total {
            font-size: 1.8rem; /* Cỡ chữ lớn hơn */
            font-weight: 700;
            color: #008848; /* Màu xanh lá cây/xanh dương nổi bật */
        }

        /* CSS cho thanh tiến trình (track) */
        .track {
            padding: 0 0;
            list-style: none;
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            position: relative;
        }
        .track:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 5%;
            right: 5%;
            height: 3px;
            background-color: #ccc; /* Màu đường line chưa hoàn thành */
            z-index: 1;
        }
        .track .step {
            position: relative;
            z-index: 2;
            width: 25%;
            text-align: center;
        }
        .track .step .icon {
            display: inline-block;
            width: 32px;
            height: 32px;
            line-height: 32px;
            border-radius: 50%;
            background-color: #ccc; /* Màu nền icon chưa hoàn thành */
            color: #fff;
            margin-bottom: 5px;
            transition: all .3s;
        }
        .track .step.active .icon {
            background-color: #008848; /* Màu nền icon hoàn thành */
        }
        .track .step.active ~ .step .icon {
            background-color: #ccc;
        }
        .track .step.active .text {
            color: #008848;
            font-weight: 600;
        }
        .track .step .text {
            display: block;
            font-size: 0.85rem;
            color: #6c757d;
        }
        /* Fix cho line sau active */
        .track .step:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            right: -50%;
            height: 3px;
            background-color: #ccc;
            z-index: -1;
        }
        .track .step:first-child:after, .track .step:last-child:after {
            content: none;
        }
        .track .step.active:after {
            background-color: #008848; /* Màu line đã hoàn thành */
        }
    </style>
</head>

<body>
<div layout:fragment="content">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="card shadow-sm">
                    <div class="card-body">

                        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                            <div>
                                <h4 class="mb-1 text-primary">
                                    <i class="fa fa-receipt me-2"></i> Chi tiết Hóa đơn #[[${billdetail.maDinhDanh}]]
                                </h4>
                                <p class="text-muted mb-0">Ngày mua hàng: <span th:text="${#temporals.format(billdetail.createdDate, 'dd-MM-yyyy HH:mm')}">25/11/2023</span></p>
                            </div>
                            <div class="d-print-none">
                                <a th:href="@{'/admin/export-pdf/'+${billdetail.maDonHang}}"
                                   class="btn btn-primary me-2"><i class="fa fa-print"></i> Xuất PDF</a>
                                <a th:href="@{'/admin/bill-list'}" class="btn btn-secondary w-md">
                                    <i class="fa fa-times"></i> Đóng
                                </a>
                            </div>
                        </div>

                        <h5 class="font-size-16 mb-3">Trạng thái đơn hàng:</h5>
                        <div class="track"
                             th:if="${billdetail.trangThaiDonHang != T(com.example.DATN2025.entity.enumClass.BillStatus).TRA_HANG && billdetail.trangThaiDonHang != T(com.example.DATN2025.entity.enumClass.BillStatus).HUY}">
                            <div class="step" th:classappend="${
                                    billdetail.trangThaiDonHang == T(com.example.DATN2025.entity.enumClass.BillStatus).CHO_XAC_NHAN ||
                                    billdetail.trangThaiDonHang == T(com.example.DATN2025.entity.enumClass.BillStatus).CHO_GIAO_HANG ||
                                    billdetail.trangThaiDonHang == T(com.example.DATN2025.entity.enumClass.BillStatus).CHO_LAY_HANG ||
                                    billdetail.trangThaiDonHang == T(com.example.DATN2025.entity.enumClass.BillStatus).HOAN_THANH  ? 'active' : ''}
                                    ">
                                            <span class="icon">
                                                <i class="fa fa-clock"></i>
                                            </span>
                                <span class="text">Chờ xác nhận</span>
                            </div>
                            <div class="step" th:classappend="${
                                    billdetail.trangThaiDonHang == T(com.example.DATN2025.entity.enumClass.BillStatus).CHO_GIAO_HANG ||
                                    billdetail.trangThaiDonHang == T(com.example.DATN2025.entity.enumClass.BillStatus).CHO_LAY_HANG ||
                                    billdetail.trangThaiDonHang == T(com.example.DATN2025.entity.enumClass.BillStatus).HOAN_THANH ? 'active' : ''}
                                    ">
                                            <span class="icon">
                                                <i class="fa fa-box"></i>
                                            </span>
                                <span class="text"> Chờ lấy hàng</span>
                            </div>
                            <div class="step" th:classappend="${
                                    billdetail.trangThaiDonHang == T(com.example.DATN2025.entity.enumClass.BillStatus).CHO_GIAO_HANG ||
                                    billdetail.trangThaiDonHang == T(com.example.DATN2025.entity.enumClass.BillStatus).HOAN_THANH  ? 'active' : ''}
                                    ">
                                <span class="icon"> <i class="fa fa-truck"></i> </span>
                                <span class="text"> Đang giao hàng </span>
                            </div>
                            <div class="step" th:classappend="${
                                    billdetail.trangThaiDonHang == T(com.example.DATN2025.entity.enumClass.BillStatus).HOAN_THANH  ? 'active' : ''}
                                    ">
                                            <span class="icon">
                                                <i class="fa fa-check-circle"></i>
                                            </span>
                                <span class="text">Hoàn thành</span>
                            </div>
                        </div>

                        <div th:if="${billdetail.trangThaiDonHang == T(com.example.DATN2025.entity.enumClass.BillStatus).HUY}" class="alert alert-danger font-weight-bold text-center p-3">
                            <i class="fa fa-ban me-2"></i> ĐƠN HÀNG ĐÃ HỦY
                        </div>
                        <div th:if="${billdetail.trangThaiDonHang == T(com.example.DATN2025.entity.enumClass.BillStatus).TRA_HANG}" class="alert alert-warning font-weight-bold text-center p-3">
                            <i class="fa fa-undo-alt me-2"></i> ĐƠN HÀNG HOÀN TRẢ
                        </div>


                        <hr class="my-4" />

                        <div class="row">
                            <div class="col-sm-6 mb-3">
                                <div class="bg-light p-3 rounded h-100">
                                    <h5 class="font-size-16 mb-3 text-dark"><i class="fa fa-user me-2"></i> Thông tin Khách hàng</h5>
                                    <p class="font-size-15 mb-2 fw-bold" th:if="${billdetail.tenKhachHang != null}"
                                       th:text="${billdetail.tenKhachHang}">Preston Miller
                                    </p>
                                    <p class="font-size-15 mb-2 font-italic text-muted"
                                       th:if="${billdetail.tenKhachHang == null}">Khách lẻ
                                    </p>
                                    <p class="mb-1 text-muted" th:if="${billdetail.tenKhachHang != null}">
                                        <i class="fa fa-map-marker-alt me-2"></i> <span th:text="${billdetail.diaChi}">4068 Post Avenue Newfolden, MN 56738</span>
                                    </p>
                                    <p class="mb-0 text-muted" th:if="${billdetail.tenKhachHang != null}">
                                        <i class="fa fa-phone me-2"></i> <span th:text="${billdetail.soDienThoai}">001-234-5678</span>
                                    </p>
                                    <p class="mb-0 text-muted">
                                        <i class="fa fa-shopping-cart me-2"></i> **Loại đơn:**
                                        <span class="fw-bold text-success" th:if="${billdetail.loaiHoaDon == T(com.example.DATN2025.entity.enumClass.InvoiceType).OFFLINE}">Tại quầy</span>
                                        <span class="fw-bold text-primary" th:if="${billdetail.loaiHoaDon == T(com.example.DATN2025.entity.enumClass.InvoiceType).ONLINE}">Online</span>
                                    </p>
                                    <p th:if="${billdetail.maGiaoDich != null and billdetail.maGiaoDich.trim() != ''}" class="mb-0 text-muted">
                                        <i class="fa fa-credit-card me-2"></i> **Mã giao dịch:** <span class="text-warning fw-bold" th:text="${billdetail.maGiaoDich}"></span>
                                    </p>
                                </div>
                            </div>
                            <div class="col-sm-6 mb-3">
                                <div class="bg-light p-3 rounded h-100">
                                    <h5 class="font-size-16 mb-3 text-dark"><i class="fa fa-store me-2"></i> Thông tin Cửa hàng</h5>
                                    <p class="mb-1 text-muted"><i class="fa fa-building me-2"></i> Tòa nhà FPT Polytechnic, Cổng số 2, 13 P. Trịnh Văn Bô</p>
                                    <p class="mb-1 text-muted"><i class="fa fa-envelope me-2"></i> ManStyle-shop@999.com</p>
                                    <p class="mb-0 text-muted"><i class="fa fa-phone-alt me-2"></i> 012-345-6789</p>
                                </div>
                            </div>
                        </div>

                        <div class="py-2">
                            <h5 class="font-size-15 mb-3"><i class="fa fa-list-alt me-2"></i> Chi tiết Sản phẩm</h5>

                            <div class="table-responsive">
                                <table class="table align-middle table-nowrap table-hover mb-0">
                                    <thead class="table-light">
                                    <tr>
                                        <th>Sản phẩm</th>
                                        <th>Màu sắc</th>
                                        <th>Kích cỡ</th>
                                        <th class="text-end">Giá tiền</th>
                                        <th class="text-center">Số lượng</th>
                                        <th class="text-end" style="width: 150px">Thành tiền</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="productDetail : ${billDetailProduct}">
                                        <td>
                                            <h6 class="text-truncate font-size-14 mb-0 fw-semibold"
                                                th:text="${productDetail.tenSanPham}">
                                                Black Strap A012
                                            </h6>
                                        </td>
                                        <td th:text="${productDetail.tenMau}"></td>
                                        <td th:text="${productDetail.kichCo}"></td>
                                        <td class="text-end"
                                            th:text="${#numbers.formatDecimal(productDetail.giaTien, 0, 'POINT', 0, 'COMMA')} + '₫'">
                                        </td>
                                        <td class="text-center" th:text="${productDetail.soLuong}"></td>
                                        <td class="text-end fw-semibold"
                                            th:text="${#numbers.formatDecimal(productDetail.tongTien, 0, 'POINT', 0, 'COMMA')} + '₫'">
                                            245.50₫
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-sm-6">
                                <div class="p-3 border rounded">
                                    <h6 class="mb-2"><i class="fa fa-tag me-2"></i> Voucher đã áp dụng:</h6>
                                    <div th:if="${billdetail.voucherName != null}">
                                        <span class="text-success fw-bold" th:text="${billdetail.voucherName}">
                                        </span>
                                    </div>
                                    <div th:if="${billdetail.voucherName == null}">
                                        <span class="text-muted">Không sử dụng Voucher</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="total-summary">
                                    <table class="table mb-0">
                                        <tbody>
                                        <tr>
                                            <th scope="row" class="border-0 text-end">Tổng tiền sản phẩm:</th>
                                            <td class="border-0 text-end fw-semibold"
                                                th:text="${#numbers.formatDecimal(total, 0, 'POINT', 0, 'COMMA')} + '₫'">
                                                732.50₫
                                            </td>
                                        </tr>
                                        <tr>
                                            <th scope="row" class="border-0 text-end text-danger">Giảm giá Voucher:</th>
                                            <td class="border-0 text-end text-danger fw-semibold"
                                                th:text="${#numbers.formatDecimal(billdetail.tienKhuyenMai, 0, 'POINT', 0, 'COMMA')} + '₫'">
                                                - 25.50₫
                                            </td>
                                        </tr>
                                        <tr>
                                            <th scope="row" class="border-0 text-end">Phí ship:</th>
                                            <td class="border-0 text-end fw-semibold">0₫</td>
                                        </tr>
                                        <tr class="border-top">
                                            <th scope="row" class="text-end">TỔNG THANH TOÁN:</th>
                                            <td class="text-end final-total">
                                                <span th:text="${#numbers.formatDecimal(total - billdetail.tienKhuyenMai, 0, 'POINT', 0, 'COMMA')} + '₫'">739.00₫</span>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="py-2 mt-4 d-flex justify-content-end bill-detail-update-status">
                            <form th:action="@{'/admin/update-bill-status2/' + ${billdetail.maDonHang}}"
                                  method="get" class="me-3">
                                <input type="hidden" name="trangThaiDonHang" value="HUY" />
                                <button type="button" class="cancel-btn btn btn-outline-danger w-md"
                                        th:if="${billdetail.trangThaiDonHang != T(com.example.DATN2025.entity.enumClass.BillStatus).TRA_HANG &&
                            billdetail.trangThaiDonHang == T(com.example.DATN2025.entity.enumClass.BillStatus).CHO_XAC_NHAN
                            || billdetail.trangThaiDonHang == T(com.example.DATN2025.entity.enumClass.BillStatus).CHO_LAY_HANG}">
                                    <i class="far fa-times-circle"></i>&nbsp; Hủy đơn này
                                </button>
                            </form>

                            <form th:action="@{'/admin/update-bill-status2/' + ${billdetail.maDonHang}}"
                                  method="get">
                                <div th:data-status="${billdetail.trangThaiDonHang}" class="btn-update-status"
                                     th:if="${billdetail.trangThaiDonHang != T(com.example.DATN2025.entity.enumClass.BillStatus).TRA_HANG &&
                                billdetail.trangThaiDonHang != T(com.example.DATN2025.entity.enumClass.BillStatus).HUY &&
                                billdetail.trangThaiDonHang != T(com.example.DATN2025.entity.enumClass.BillStatus).HOAN_THANH}">

                                        <span class="btn btn-success w-md"
                                              th:if="${billdetail.trangThaiDonHang == T(com.example.DATN2025.entity.enumClass.BillStatus).CHO_XAC_NHAN}">
                                            <i class="far fa-check-square"></i>&nbsp; Xác nhận & Duyệt đơn</span>

                                    <span class="btn btn-primary w-md"
                                          th:if="${billdetail.trangThaiDonHang == T(com.example.DATN2025.entity.enumClass.BillStatus).CHO_LAY_HANG}">
                                            <i class="fa fa-shipping-fast"></i>&nbsp; Bàn giao Shipper</span>

                                    <span class="btn btn-info w-md text-white"
                                          th:if="${billdetail.trangThaiDonHang == T(com.example.DATN2025.entity.enumClass.BillStatus).CHO_GIAO_HANG}">
                                            <i class="fa fa-clipboard-check"></i>&nbsp; Xác nhận đã Giao</span>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // ... (Giữ nguyên script JS)
        $(".cancel-btn").on("click", function (e) {
            e.stopPropagation();
            Swal.fire({
                title: "Xác nhận?",
                text: `Bạn chắc chắn muốn hủy đơn này, thao tác này không thể trở lại!`,
                icon: "warning",
                showCancelButton: true,
                cancelButtonText: "Hủy",
                confirmButtonText: "Xác nhận",
                reverseButtons: true,
            }).then((result) => {
                if (result.isConfirmed) {
                    $(this).closest("form").submit();
                }
            });
        });

        $(".btn-update-status").on("click", function (e) {
            e.stopPropagation();
            var currentStatus = $(this).attr("data-status");
            var nextStatus;
            var statusMessage;
            switch (currentStatus) {
                case "CHO_XAC_NHAN":
                    nextStatus = "CHO_LAY_HANG";
                    statusMessage = "Chờ lấy hàng";
                    break;
                case "CHO_LAY_HANG":
                    nextStatus = "CHO_GIAO_HANG";
                    statusMessage = "Đang giao hàng";
                    break;
                case "CHO_GIAO_HANG":
                    nextStatus = "HOAN_THANH";
                    statusMessage = "Hoàn thành";
                    break;
            }
            Swal.fire({
                title: "Xác nhận?",
                text: `Xác nhận chuyển sang trạng thái **${statusMessage}**`,
                icon: "warning",
                showCancelButton: true,
                cancelButtonText: "Hủy",
                confirmButtonText: "Xác nhận",
                reverseButtons: true,
            }).then((result) => {
                if (result.isConfirmed) {
                    const form = $(this).closest("form");
                    var url = form.attr("action") + `?trangThaiDonHang=${nextStatus}`;
                    window.location.href = url;
                }
            });
        });
    </script>
</div>
</body>

</html>
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/admin-layout.html}">

<head>
    <meta charset="UTF-8">
    <title>Thêm/Sửa Sản Phẩm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
        :root {
            --primary: #007bff;
            --secondary: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --border-color: #dee2e6;
            --shadow-light: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        .custom-modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: none;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-light);
            animation-name: animatetop;
            animation-duration: 0.4s
        }

        @keyframes animatetop {
            from {top: -300px; opacity: 0}
            to {top: 10%; opacity: 1}
        }

        .modal-header h5 {
            font-weight: 600;
            color: #343a40;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            padding: 5px;
            position: absolute;
            right: 15px;
            top: 5px;
        }

        .close:hover { color: #000; }

        .form-row { display: flex; flex-wrap: wrap; margin-right: -15px; margin-left: -15px; }
        .form-row > .form-group { padding-right: 15px; padding-left: 15px; margin-bottom: 1rem; }

        .form-group label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #343a40;
        }

        .form-control, .form-select {
            border-radius: 0.25rem;
            border: 1px solid #ced4da;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-control:focus, .form-select:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
        }

        .error { color: var(--danger); font-size: 0.875rem; margin-top: 0.25rem; display: block; }
        .red_require { color: var(--danger); margin-left: 2px; }

        .select-container { position: relative; display: flex; flex-direction: column; }
        .select-container .form-select { width: 100%; padding-right: 2.5rem; }

        .plus-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--success);
            font-size: 1.1rem;
        }

        .plus-icon:hover { color: #1e7e34; }

        @media (max-width: 768px) {
            .form-row > .form-group { width: 100%; padding-right: 0; padding-left: 0; }
            .modal-content { margin: 5% auto; width: 95%; }
        }
    </style>
</head>
<body>
<div layout:fragment="content">

    <!-- Các Modal thêm mới -->
    <!-- Brand Modal -->
    <div class="custom-modal" id="add-brand-modal">
        <div class="modal-content rounded-3">
            <span class="close" id="closeBrandModal">&times;</span>
            <div class="modal-header border-bottom-0 pb-0 mb-3">
                <h5 class="modal-title">Thêm nhãn hàng mới</h5>
            </div>
            <form id="brand-form">
                <div class="form-group mb-3">
                    <label for="brandCode"><i class="fas fa-barcode"></i>Mã nhãn hàng:<span class="red_require">*</span></label>
                    <input class="form-control" type="text" id="brandCode" placeholder="Nhập mã nhãn hàng">
                    <span class="error"></span>
                </div>
                <div class="form-group mb-4">
                    <label for="brandName"><i class="fas fa-tag"></i>Tên nhãn hàng:<span class="red_require">*</span></label>
                    <input class="form-control" type="text" id="brandName" placeholder="Nhập tên nhãn hàng">
                    <span class="error"></span>
                </div>
                <button class="btn btn-primary mt-2 w-100" id="save-brand-btn" type="submit">Lưu</button>
            </form>
        </div>
    </div>

    <!-- Category Modal -->
    <div class="custom-modal" id="add-category-modal">
        <div class="modal-content rounded-3">
            <span class="close" id="closeCategoryModal">&times;</span>
            <div class="modal-header border-bottom-0 pb-0 mb-3">
                <h5 class="modal-title">Thêm loại hàng mới</h5>
            </div>
            <form id="category-form">
                <div class="form-group mb-3">
                    <label for="categoryCode"><i class="fas fa-code"></i>Mã loại:<span class="red_require">*</span></label>
                    <input class="form-control" type="text" id="categoryCode" placeholder="Nhập mã loại">
                    <span class="error"></span>
                </div>
                <div class="form-group mb-4">
                    <label for="categoryName"><i class="fas fa-layer-group"></i>Tên loại:<span class="red_require">*</span></label>
                    <input class="form-control" type="text" id="categoryName" placeholder="Nhập tên loại">
                    <span class="error"></span>
                </div>
                <button class="btn btn-primary mt-2 w-100" id="save-category-btn" type="submit">Lưu</button>
            </form>
        </div>
    </div>

    <!-- Material Modal -->
    <div class="custom-modal" id="add-material-modal">
        <div class="modal-content rounded-3">
            <span class="close" id="closeMaterialModal">&times;</span>
            <div class="modal-header border-bottom-0 pb-0 mb-3">
                <h5 class="modal-title">Thêm chất liệu mới</h5>
            </div>
            <form id="material-form">
                <div class="form-group mb-3">
                    <label for="materialCode"><i class="fas fa-cube"></i>Mã chất liệu:<span class="red_require">*</span></label>
                    <input class="form-control" type="text" id="materialCode" placeholder="Nhập mã chất liệu">
                    <span class="error"></span>
                </div>
                <div class="form-group mb-4">
                    <label for="materialName"><i class="fas fa-box-open"></i>Tên chất liệu:<span class="red_require">*</span></label>
                    <input class="form-control" type="text" id="materialName" placeholder="Nhập tên chất liệu">
                    <span class="error"></span>
                </div>
                <button class="btn btn-primary mt-2 w-100" id="save-material-btn" type="submit">Lưu</button>
            </form>
        </div>
    </div>

    <!-- MAIN PRODUCT FORM -->
    <div class="card shadow-sm p-4 mb-4 rounded-3">
        <h4 class="card-title mb-4">Thông tin sản phẩm</h4>
        <form th:object="${product}" th:method="post" th:action="${action}" id="formProduct1">

            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="code"><i class="fas fa-barcode"></i>Mã sản phẩm</label>
                    <input type="text" class="form-control" th:field="*{code}" id="code" placeholder="---Mã tự động nếu để trống---">
                    <span class="error"></span>
                </div>
                <div class="form-group col-md-6">
                    <label for="name"><i class="fas fa-tag"></i>Tên sản phẩm<span class="red_require">*</span></label>
                    <input type="text" class="form-control" th:field="*{name}" id="name">
                    <span class="error"></span>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-6">
                    <label><i class="fas fa-building"></i>Nhãn hàng<span class="red_require">*</span></label>
                    <div class="select-container">
                        <select class="form-select" th:field="*{brand}" id="brand">
                            <option th:value="${brand.id}" th:each="brand: ${listBrand}" th:text="${brand.name}"></option>
                        </select>
                        <span id="add-brand" class="plus-icon" title="Thêm nhãn hàng mới"><i class="fas fa-plus"></i></span>
                    </div>
                </div>
                <div class="form-group col-md-6">
                    <label><i class="fas fa-list"></i>Thể loại<span class="red_require">*</span></label>
                    <div class="select-container">
                        <select class="form-select" th:field="*{category}" id="category">
                            <option th:value="${category.id}" th:each="category: ${listCategory}" th:text="${category.name}"></option>
                        </select>
                        <span id="add-category" class="plus-icon" title="Thêm loại hàng mới"><i class="fas fa-plus"></i></span>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-6">
                    <label><i class="fas fa-cubes"></i>Chất liệu<span class="red_require">*</span></label>
                    <div class="select-container">
                        <select class="form-select" th:field="*{material}" id="material">
                            <option th:value="${material.id}" th:each="material: ${listMaterial}" th:text="${material.name}"></option>
                        </select>
                        <span id="add-material" class="plus-icon" title="Thêm chất liệu mới"><i class="fas fa-plus"></i></span>
                    </div>
                </div>
                <div class="form-group col-md-6">
                    <label for="status"><i class="fas fa-toggle-on"></i>Trạng thái<span class="red_require">*</span></label>
                    <select class="form-select" th:field="*{status}" id="status">
                        <option th:value="1" th:text="'Còn bán'"></option>
                        <option th:value="2" th:text="'Ngừng bán'"></option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="gender"><i class="fas fa-venus-mars"></i>Giới tính<span class="red_require">*</span></label>
                    <select class="form-select" th:field="*{gender}" id="gender">
                        <option th:value="1" th:text="'Nam'"></option>
                        <option th:value="2" th:text="'Nữ'"></option>
                        <option th:value="3" th:text="'Unisex'"></option>
                    </select>
                </div>
                <div class="form-group col-md-6">
                    <label for="describe"><i class="fas fa-pen"></i>Mô tả</label>
                    <textarea class="form-control" th:field="*{describe}" id="describe" rows="3" placeholder="Nhập mô tả sản phẩm"></textarea>
                    <span class="error"></span>
                </div>
            </div>

            <div class="d-flex justify-content-end mt-4">
                <a href="/admin/product-all" class="btn btn-dark m-1"><i class="fas fa-undo-alt"></i> Hủy</a>
                <button type="submit" class="btn btn-primary m-1"><i class="fas fa-arrow-right"></i> Tiếp theo</button>
            </div>
        </form>

        <div th:if="${duplicateCode!=null}" th:text="${duplicateCode}" class="alert alert-danger ml-2 py-2 px-2 mt-3"></div>
    </div>

    <script th:inline="javascript">
        $(document).ready(function () {
            $('#add-brand').on('click', () => $('#add-brand-modal').show());
            $('#add-category').on('click', () => $('#add-category-modal').show());
            $('#add-material').on('click', () => $('#add-material-modal').show());
            $('.close').on('click', function () { $(this).closest('.custom-modal').hide(); });

            Validator({
                form: '#brand-form',
                formGroupSelector: '.form-group',
                errorSelector: '.error',
                rules: [
                    Validator.isRequired('#brandName', 'Vui lòng nhập tên nhãn hàng'),
                    Validator.isRequired('#brandCode', 'Vui lòng nhập mã nhãn hàng'),
                    Validator.maxLength('#brandName', 30),
                    Validator.maxLength('#brandCode', 20)
                ],
                onSubmit: async (data) => {
                    const dataSend = { code: data.brandCode, name: data.brandName };
                    await $.ajax({
                        type: 'POST',
                        dataType: 'json',
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify(dataSend),
                        url: '/api/brand',
                        success: (data) => {
                            $("#add-brand-modal").hide();
                            $('#brand').append(`<option value="${data.id}">${data.name}</option>`);
                            $('#brand').val(`${data.id}`);
                        },
                        error: (xhr) => {
                            Swal.fire({ title: "Lỗi", text: xhr.responseJSON.message, icon: "error" });
                        }
                    })
                }
            });

            Validator({
                form: '#category-form',
                formGroupSelector: '.form-group',
                errorSelector: '.error',
                rules: [
                    Validator.isRequired('#categoryCode', 'Vui lòng nhập mã loại hàng'),
                    Validator.isRequired('#categoryName', 'Vui lòng nhập tên loại hàng'),
                    Validator.maxLength('#categoryName', 30),
                    Validator.maxLength('#categoryCode', 20)
                ],
                onSubmit: async (data) => {
                    const dataSend = { code: data.categoryCode, name: data.categoryName };
                    await $.ajax({
                        type: 'POST',
                        dataType: 'json',
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify(dataSend),
                        url: '/api/category',
                        success: (data) => {
                            $("#add-category-modal").hide();
                            $('#category').append(`<option value="${data.id}">${data.name}</option>`);
                            $('#category').val(`${data.id}`);
                        },
                        error: (xhr) => {
                            Swal.fire({ title: "Lỗi", text: xhr.responseJSON.message, icon: "error" });
                        }
                    })
                }
            });

            Validator({
                form: '#material-form',
                formGroupSelector: '.form-group',
                errorSelector: '.error',
                rules: [
                    Validator.isRequired('#materialCode', 'Vui lòng nhập mã chất liệu'),
                    Validator.isRequired('#materialName', 'Vui lòng nhập tên chất liệu'),
                    Validator.maxLength('#materialName', 30),
                    Validator.maxLength('#materialCode', 20)
                ],
                onSubmit: async (data) => {
                    const dataSend = { code: data.materialCode, name: data.materialName };
                    await $.ajax({
                        type: 'POST',
                        dataType: 'json',
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify(dataSend),
                        url: '/api/material',
                        success: (data) => {
                            $("#add-material-modal").hide();
                            $('#material').append(`<option value="${data.id}">${data.name}</option>`);
                            $('#material').val(`${data.id}`);
                        },
                        error: (xhr) => {
                            Swal.fire({ title: "Lỗi", text: xhr.responseJSON.message, icon: "error" });
                        }
                    })
                }
            });

            Validator({
                form: '#formProduct1',
                formGroupSelector: '.form-group',
                errorSelector: '.error',
                rules: [
                    Validator.isRequired('#name', 'Vui lòng nhập tên sản phẩm'),
                    Validator.maxLength('#name', 100),
                    Validator.maxLength('#code', 20),
                    Validator.maxLength('#describe', 300)
                ]
            });
        });
    </script>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
</body>
</html>

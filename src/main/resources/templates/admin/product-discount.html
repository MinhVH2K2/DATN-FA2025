<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/admin-layout.html}">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n l√Ω gi·∫£m gi√° s·∫£n ph·∫©m</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"
          integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
          crossorigin="anonymous"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

  <style>
    /* T·ªëi ∆∞u hi·ªÉn th·ªã cho b·∫£ng */
    td {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap; /* NgƒÉn ch·∫∑n xu·ªëng d√≤ng */
    }

    /* T√πy ch·ªânh button ƒë·ªÉ icon v√† text n·∫±m ngang */
    .btn-action {
      display: flex;
      align-items: center;
      gap: 5px; /* Kho·∫£ng c√°ch gi·ªØa icon v√† text */
    }

    /* Hi·ªáu ·ª©ng bo tr√≤n v√† ƒë·ªï b√≥ng cho header/panel */
    .section {
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      margin-top: 20px;
    }

    /* T√πy ch·ªânh DataTables */
    #myTable_wrapper {
      padding: 15px 0;
    }
  </style>
</head>
<body>

<div class="bg-light min-vh-100">
  <div class="" layout:fragment="content">
    <div class="section bg-white px-4 py-4 min-vh-100">
      <h2 class="mt-3 text-primary">Qu·∫£n l√Ω Gi·∫£m gi√° S·∫£n ph·∫©m üè∑Ô∏è</h2>

      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/admin" class="text-decoration-none">Home</a></li>
          <li class="breadcrumb-item active" aria-current="page">Gi·∫£m gi√° s·∫£n ph·∫©m</li>
        </ol>
      </nav>

      <div class="d-flex justify-content-end mb-4">
        <a th:href="@{/admin-only/product-discount-create}" class="btn btn-success btn-action rounded-pill px-4 py-2">
          <i class="bi bi-plus-circle-fill"></i>
          <span>T·∫°o Gi·∫£m gi√° M·ªõi</span>
        </a>
      </div>

      <div class="alert alert-success" th:if="${message != null}" th:text="${message}"></div>

      <div class="mt-3 table-responsive">
        <table id="myTable" class="table table-hover table-striped">
          <thead class="table-primary">
          <tr>
            <th>M√£ SP</th>
            <th>T√™n s·∫£n ph·∫©m</th>
            <th>M√†u</th>
            <th>C·ª°</th>
            <th>Gi√° g·ªëc</th>
            <th>Gi√° sau gi·∫£m</th>
            <th>B·∫Øt ƒë·∫ßu</th>
            <th>K·∫øt th√∫c</th>
            <th>Tr·∫°ng th√°i</th>
            <th>Thao t√°c</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="discount : ${productDiscounts}">
            <td th:text="${discount.productDetail.product.code}"></td>
            <td th:text="${discount.productDetail.product.name}"></td>
            <td th:text="${discount.productDetail.color.name}"></td>
            <td th:text="${discount.productDetail.size.name}"></td>
            <td>
              <span class="text-decoration-line-through" th:text="${#numbers.formatDecimal(discount.productDetail.price, 0, 'POINT', 0, 'COMMA')}"></span> ƒë
            </td>
            <td>
              <span class="fw-bold text-danger" th:text="${#numbers.formatDecimal(discount.discountedAmount, 0, 'POINT', 0, 'COMMA')}"></span> ƒë
            </td>
            <td th:text="${#dates.format(discount.startDate, 'dd/MM/yyyy')}"></td>
            <td th:text="${#dates.format(discount.endDate, 'dd/MM/yyyy')}"></td>
            <td>
                            <span th:if="${discount.closed}" class="badge bg-danger rounded-pill px-3 py-2">
                                <i class="bi bi-x-circle-fill me-1"></i>ƒê√£ ƒë√≥ng
                            </span>
              <span th:if="${discount.closed == false}" class="badge bg-success rounded-pill px-3 py-2">
                                <i class="bi bi-check-circle-fill me-1"></i>Ho·∫°t ƒë·ªông
                            </span>
            </td>
            <td>
              <button th:if="${discount.closed == false}" th:data-close-id="${discount.id}" class="close-discount-btn btn btn-sm btn-outline-danger btn-action rounded-pill">
                <i class="bi bi-lock-fill"></i>
                ƒê√≥ng
              </button>
              <button th:if="${discount.closed}" th:data-open-id="${discount.id}" class="open-discount-btn btn btn-sm btn-outline-success btn-action rounded-pill">
                <i class="bi bi-unlock-fill"></i>
                M·ªü
              </button>

            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>


    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script th:inline="javascript">
      $(document).ready( function () {

        // Kh·ªüi t·∫°o DataTables (gi·ªØ nguy√™n logic)
        new DataTable('#myTable', {
          order: [],
          language: {
            search: "T√¨m ki·∫øm:",
            "lengthMenu": "Hi·ªÉn th·ªã _MENU_ b·∫£n ghi 1 trang",
            "zeroRecords": "Kh√¥ng t√¨m th·∫•y b·∫£n ghi n√†o",
            "info": "Hi·ªÉn th·ªã trang _PAGE_ trong _PAGES_",
            "paginate": {
              "first":      "<<",
              "last":       ">>",
              "next":       ">",
              "previous":   "<"
            },
          }
        })
                .on('draw.dt', () => setEvent())

        setEvent()

        // Logic x·ª≠ l√Ω s·ª± ki·ªán ƒê√≥ng/M·ªü (gi·ªØ nguy√™n logic)
        function setEvent() {
          $('.close-discount-btn').off('click').on('click', function () { // S·ª≠ d·ª•ng .off('click') ƒë·ªÉ tr√°nh g√°n nhi·ªÅu l·∫ßn
            var closeId = $(this).attr('data-close-id')
            Swal.fire({
              title: 'X√°c nh·∫≠n ƒê√≥ng gi·∫£m gi√°',
              text: 'B·∫°n ch·∫Øc ch·∫Øn mu·ªën ƒë√≥ng gi·∫£m gi√° n√†y?',
              icon: 'warning',
              showCancelButton: true,
              confirmButtonText: 'X√°c nh·∫≠n ƒê√≥ng',
              cancelButtonText: 'H·ªßy'
            }).then(async (result) => {
              if (result.isConfirmed) {
                await $.ajax({
                  type: 'POST',
                  url: `/api/private/product-discount/${closeId}/status/true`,
                  dataType: 'json',
                  success: async function () {
                    await Toastify({
                      text: "ƒê√≥ng gi·∫£m gi√° th√†nh c√¥ng",
                      className: "success",
                      style: { background: "linear-gradient(to right, #00b09b, #96c93d)", }
                    }).showToast();
                    window.location.reload()
                  },
                  error: function (xhr, status, error) {
                    Swal.fire("L·ªói", xhr.responseJSON.message || "ƒê√£ x·∫£y ra l·ªói!", "error")
                  }
                })
              }
            });
          })
          $('.open-discount-btn').off('click').on('click', function () {
            var openId = $(this).attr('data-open-id')
            Swal.fire({
              title: 'X√°c nh·∫≠n M·ªü gi·∫£m gi√°',
              text: 'B·∫°n ch·∫Øc ch·∫Øn mu·ªën m·ªü l·∫°i gi·∫£m gi√° n√†y?',
              icon: 'question',
              showCancelButton: true,
              confirmButtonText: 'X√°c nh·∫≠n M·ªü',
              cancelButtonText: 'H·ªßy'
            }).then(async (result) => {
              if (result.isConfirmed) {
                await $.ajax({
                  type: 'POST',
                  url: `/api/private/product-discount/${openId}/status/false`,
                  dataType: 'json',
                  success: async function () {
                    await Toastify({
                      text: "M·ªü gi·∫£m gi√° th√†nh c√¥ng",
                      className: "success",
                      style: { background: "linear-gradient(to right, #007bff, #52a8ff)", }
                    }).showToast();
                    window.location.reload()
                  },
                  error: function (xhr, status, error) {
                    Swal.fire("L·ªói", xhr.responseJSON.message || "ƒê√£ x·∫£y ra l·ªói!", "error")
                  }
                })
              }
            });
          })
        }
      });
    </script>
  </div>
</div>

</body>
</html>